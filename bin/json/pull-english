#!/usr/bin/env ruby

##
# This script requests each verse, in each chapter
# of The Qur'an - in the English language. The content
# is requested from the https://quran.com website.
#
# Each chapter is then saved to a JSON file - for example:
# "src/en/1.json", "src/en/2.json", etc.

##
# Dependencies
require "net/http"
require "nokogiri"
require "json"
require "paint"
require_relative "../../binlib/line"

##
# Configuration variables.
base_uri = "quran.com"
dest = File.join("src", "json", "en", "%{chapter}.json")
delay = 1.5

##
# Utils
line = Line.new($stdout)
find_content = ->(res) do
  html = Nokogiri::HTML(res.body)
  el = html.css("div[class^='TranslationText']").last
  el.text.gsub(/[0-9]/, "")
end

##
# Map chapters to their verse count.
vmap_path = File.join("bindata", "chapters-length.json")
vmap = JSON.parse(File.read(vmap_path))

##
# Share a single Net::HTTP instance.
http = Net::HTTP.new(base_uri, 443)
http.use_ssl = true

1.upto(114) do |chapter|
  path = format(dest, chapter:)
  rows = []
  vcount = vmap[chapter.to_s]

  1.upto(vcount) do |verse|
    line.rewind.print "Download: #{verse}/#{vcount}"
    res = http.request_get("/#{chapter}/#{verse}")
    if Net::HTTPOK === res
      rows.push([verse, find_content.(res)])
    else
      print "\n", Paint["Error: ", :red, :bold], res.class, "\n"
      exit(1)
    end
    sleep delay
  end
  File.write(path, JSON.pretty_generate(rows))
  print "\n", Paint["OK: ", :green, :bold], path, "\n"
end
